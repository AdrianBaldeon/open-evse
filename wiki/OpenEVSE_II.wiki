#summary A new version of OpenEVSE

= Introduction =

I decided to try my hand at designing a new version of OpenEVSE.

One of the hallmarks of my work on the Hydra has been the segregation of the HV wiring and control systems from the logic. I decided to make that the centerpiece of the design for OpenEVSE II.

It consists of two boards - an HV board and a logic / display board. There are three choices for the HV board. The first is a board with two DC relays mounted on it. It's similar to the OpenEVSE DIY 30A board. It's usable at L1 or L2, but only rated for 24A charging maximum. The second choice is the Contactor board. It will control an external line voltage powered contactor to turn the car power on and off. It has no limitation on charging current - that limitation is imposed by your  choice of contactor. However, the contactor coil will only work at one voltage, so that means it'll be useful for 208/240 volt charging only (in principle you could use a 120 volt contactor for an L1 contactor EVSE, but in practice, you would be unlikely to want to do so). The third variant is for external relays. It provides a 12vdc switched output for driving a relay, but like the contactor variant, the relay is supplied by the builder and is the limiting factor for current capacity. High current relays (with 12 vdc coils) are much more rare than contactors. However, if you can find one, the resulting design would be usable at both L1 and L2.

No voltages higher than 12 volts are present on the logic/display board. The HV + Relay board is designed to be as simple and safe as is possible for such a device. The two boards connect to one another with a "mezzanine" cable - a 10 pin FFC.

The firmware used is the same OpenEVSE firmware. Be sure to compile the firmware with the OPENEVSE_2 macro defined. That will alter the code for compatibility.

= Details =

== Wiring ==

Wiring is almost the same as traditional OpenEVSE. The only changes are the addition of an optional ammeter CT coil and the mezzanine cable connecting the two boards.

[http://www.kfu.com/~nsayer/hydra/OpenEVSE_II_Wiring_Relay.png]
The wiring for the relay variant

[http://www.kfu.com/~nsayer/hydra/OpenEVSE_II_Wiring_Contactor.png]
The wiring for the contactor variant

On the HV + Relay board, there are two SPST relays (not unlike the OpenEVSE DIY 30A board). QD terminals crimped onto the power and J1772 hot leads connect to these two relays. The PCB connections on the relays provide AC power and relay test signals to the rest of the board. _Both_ J1772 hot lines must pass through the GFI coil, and then (optionally) _one_ of the hot lines must pass through the ammeter coil.

The CT coil wiring, J1772 pilot line and ground connect to the logic/display board along with the mezzanine cable. Be sure the mezzanine cable is oriented the correct way - pin 1 must be connected to pin 1 on both ends! This means you must use a 10 pin 1 mm FFC cable with the "top/bottom" orientation. That means that the pins are exposed on opposite sides on each end. This effectively gives the cable a half-twist, which will connect pin 1 to pin 1 on the two boards.

A select button (the pinout of the 3 pin terminal is the same as on the OpenEVSE display board) connects to its terminal on the logic/display board.

A CR1220 battery in the battery clip will preserve the clock when power is disconnected.

== Construction ==

You will need

  * A complete logic/display board
  * A complete HV board - either the 30A relay, contactor or external relay board.
  * For the contactor or external relay HV board, you'll need an appropriate contactor or relay.
  * An OpenEVSE chassis (available from the OpenEVSE store - either the aluminum or polycarb variant)
  * A mezzanine cable (10 pin 1 mm FFC top/bottom ended)
  * A ground bus
  * A lit pushbutton (available from the OpenEVSE store)
  * A GFI current transformer (available from the OpenEVSE store - CR Magnetics 8420-1000G recommended)
  * An ammeter current transformer (available from the OpenEVSE store - CR Magnetics 8420-1000 recommended)
  * An AC cable
  * A J1772 cable / plug assembly

Note the mounting hole dimensions for each of the different HV boards:
  * For the contactor board, 2.4 x 2.2 inches
  * For the relay board, 3.2 x 2.7 inches
  * For the external relay board, 2.7 x 1.7 inches

Start with the (plastic or metal) mounting plate that came with the chassis. Mark the four corners of a square for the mounting holes for the HV board. You need to arrange the board so that it is out of the way of the other components that will be mounted on the mounting plate - specifically the relay or contactor (if applicable), the fuse block (again, if applicable) and the ground bus. Drill the holes with a 1/8" drill bit.

If you're going to use an external relay or contactor, then similarly mark and drill the appropriate mounting holes for it. Be sure to leave enough room around the contactor or relay to bend the AC and J1772 cables, including enough room to mount the two current transformers on the J1772 hot lines. Also, insure there's enough space for the QD terminals for the AC power, relay test and relay and/or contactor coil lines.

Attach the HV/Relay board to the mounting plate using the mounting hardware originally intended for the OpenEVSE v2 board using the newly drilled holes. Similarly, attach the relay or contactor (if applicable), the fuse block and the ground bus to the mounting plate using its intended hardware.

If your mounting plate is plastic, crimp a QD terminal onto a 12 gauge copper wire. Connect the QD terminal to the ground terminal on the HV board and the other end of the wire to the ground bus. If your mounting plate is metal, then you can skip this step as the metal mounting hardware should provide a sufficient electrical connection to ground via the mounting plate and ground bus.

Similarly, if your mounting plate is plastic, crimp a spade or ring crimp terminal to a second 12 gauge wire and attach the loose end to the ground bus. The ring/spade terminal will go under one of the screws holding the panel into the chassis (this will ground the chassis. Do not omit this step! It is hazardous to leave the chassis ungrounded). If your chassis is plastic, then this step is not required.

Place the mounting plate in the chassis and screw down each corner using the supplied mounting hardware. Be sure to place the grounding ring/spade terminal under its intended screw, if applicable.

=== Relay HV board steps ===
Use #10 QD terminals and short lengths of 10 gauge stranded copper wire to connect one end of each fuse block pole to a "LINE" terminal on the HV relay board. Prepare the AC cable by stripping 6 inches of its outer jacket and installing a cable gland. Trim the individual wires to the correct length and connect one hot line of the AC cable to each fuse block on the input side. Connect the ground wire of the AC cable to the ground bus.

Prepare the J1772 cable by stripping 6 inches off the outer jacket. Locate and identify each wire - the two hots, the ground and the pilot. If your cable includes a proximity wire, trim it short to keep it out of the way. Install the cable into its cable gland and install the gland in its chassis hole. Estimate how long the two hots and ground must be to reach their destination. Be sure to leave room for the GFI over both hit lines and the ammeter coil over one of them. Cut the hot and ground wires to length. Install QD terminals on the hot wires. Screw the ground wire into the ground bus. Pass both hot lines through the GFI CT coil and one of the hot lines (it doesn't matter which) through the ammeter coil. Attach the QD terminals to the LOAD terminals on the relays.

=== Contactor HV board steps ===

Prepare the AC cable by stripping 6 inches of its outer jacket and installing a cable gland. Trim the individual wires to the correct length and connect one hot line of the AC cable to the contactor on the line side. Connect the ground wire of the AC cable to the ground bus.

Prepare the J1772 cable by stripping 6 inches off the outer jacket. Locate and identify each wire - the two hots, the ground and the pilot. If your cable includes a proximity wire, trim it short to keep it out of the way. Install the cable into its cable gland and install the gland in its chassis hole. Estimate how long the two hots and ground must be to reach their destination. Be sure to leave room for the GFI over both hit lines and the ammeter coil over one of them. Cut the hot and ground wires to length. Screw the ground wire into the ground bus. Pass both hot lines through the GFI CT coil and one of the hot lines (it doesn't matter which) through the ammeter coil. Attach the two hot wires to the LOAD terminals on the contactor.

Prepare three pairs of 22 gauge wires by twisting them together and attaching 22 gauge QD crimp terminals to each on one end. Attach one pair each to the auxiliary QD terminals on the contactor on the line side, load side and the contactor coil. Connect each pair to the screw terminals on the HV board, as appropriate, to the AC in (contactor line side) block, the relay test (contactor load side) block, and the contactor (contactor coil) block.

Attach one end of the mezzanine cable to the HV/relay board, taking careful note of the location of pin 1.

Set the chassis aside for now.

Prepare the lid by attaching the waterproofing gasket (if you bought one) and the LCD waterproofing kit (again, if you bought it). Solder the 3 wire cable onto the select switch as instructed and install the button in the hole in the lid. Install the OpenEVSE II logic/display board onto the 4 mounting posts in the lid. Connect the button cable up to the SELECT 3 pin terminal on the board. Connect the GFI CT coil up to the GFI terminals, noting the orientation - the GFI test pin is the left, the GFI pin is in the center, and ground is on the right. Connect the ammeter coil up to its terminal block - orientation does not matter. Connect the J1772 pilot wire up to the left terminal of the pilot block (top screw). Connect the mezzanine cable up to the mezzanine connector in the upper left corner, carefully noting the position of pin 1.

Install a CR1220 battery in the battery clip.

Set the lid on top of the box, carefully inspecting the fit to insure that none of the wires place undue pressure on either of the board and that no wires are pinched. Screw the lid onto the box with the 6 chassis screws.

Assembly is now complete.

= Theory of operation =

Feel free to follow along with the schematics (below). Each subsection here corresponds to a page of the schematic.

=== Power / GFI ===

There are two DC/DC converters built around the venerable MC34063 chip, The one on the left is a buck topology to reduce the 12 volts input to 5 volts at up to 250 mA. The one on the right is an inverting topology to turn +12 volts into -12 volts at up to 50 mA. Since the only use for the -12 volts is the pilot generator, there's a 2.4 k-ohm resistor across it to provide a minimal load. This improves the efficiency and stability of the converter.

The GFI is in three basic pieces. The first op-amp stage is a rectifying amplifier with a gain of 100 and a low-pass filter with a roll-off of 120 Hz (or so). It gets its input from the GFI current transformer. A current transformer outputs a current proportional to the current flowing on the conductor(s) passing through it. For a GFI, the two power supply conductors pass through it, and in a correct environment, all of the current flowing out through one of them should be balanced by the same amount of current flowing back through the other, for a net result of 0. If the current can find some other path to ground, the resulting imbalance will result in a current output from the CT. Immediately across the CT is a burden resistor. The burden resistor's job is to convert the current into a voltage that can be measured. There is a zener diode clamp to protect the amplifier from excessive voltage swings in the case of massive imbalances. The output of the amplifier goes into a peak-hold capacitor and is then fed into a comparator. Whenever the held-peak exceeds the comparison voltage (calibrated for somewhat less than 20 mA, but not so much less to be a nuisance), it interrupts the controller.

In addition, there's a GFI test circuit. This is merely a current limiting resistor. It's intended to be connected to a wire that takes 3 or 4 loops around and through the GFI coil and then connects to ground. The controller can test the GFI by pulsing this line with a 60 Hz square wave The multiple loops will serve to amplify the impact of the current flowing through the wire (each loop through represents another wire with the same current flowing through it), assuring that the GFI will trigger.

=== Car signalling ===

The ammeter consists of another current transformer. In this case, only a single hot line passes through so rather than sensing any current imbalance, we will sense the total current flow. As before, there is a burden resistor and a zener clamp to protect the micro controller's A/D converter from excessive voltage, this time caused potentially by too much current. To keep the (expected) voltages positive, one leg of the CT is anchored to 2.5 volts with a voltage divider. The capacitor to ground from this leg is intended to reduce noise, by providing it a direct path to ground.

The pilot generator is a set of four transistors in a modified half-H bridge configuration. The output is a pair of PNP and NPN transistors in a push-pull arrangement from +/- 12 volts. Each transistor has a pull-up or down resistor on its base intended - in the default case - to keep the transistor switched off.

From each base there is a second complimentary transistor wired up to switch the final transistor on when the appropriate logic level is present on its input. On the high side, an NPN transistor will bring the PNP transistor's base to ground, causing it to turn on, but only when the first transistor's base is high. On the low side, a PNP transistor will bring the NPN transistor's base towards +5 volts, causing it to turn on, but only when the primary transistor's base is low. Finally, there is a pull-up resistor on the input to insure that there is always an unambiguous state present. When programming the controller, the pilot pin will be in a high impedance state. Without the pull-up, both transistors would wind up being on, shorting -12 to +12.

On the output there is a 1k impedance setting resistor mandated by the spec. After that there is a sampling resistor network. It's intended to scale the +/-12 volts on the pilot line to 0-5 volts to present to an A/D pin on the controller. This allows the controller to sense the state requested by the car and insure the presence of the pilot diode in the vehicle.

=== Controller / display ===

The micro controller is the ATMega328p with a 16 MHz crystal. A crystal is called for in particular because the 1 kHz pilot has a frequency tolerance specification that requires that level of accuracy. 16 MHz is an otherwise arbitrary choice, but it is compatible with the Arduino Uno, from which the legacy of OpenEVSE is derived.

The i2c bus of the controller goes to an MC23017 i2c-to-GPIO expander chip, which is in turn connected to the RGB LCD and to the select button. This portion is exactly the same as both the AdaFruit i2c RGB LCD Arduino shield and the OpenEVSE display backpack. The i2c bus also goes to a DS1307 RTC chip, also equipped with its own crystal and backup battery.

=== HV board(s) ===

Each HV board has five jobs:
  # Provide 12 volts DC to power the logic board
  # Switch the car power on and off
  # Provide a crude voltmeter for the input AC power
  # Perform a ground impedance test
  # Perform a relay output state (aka stuck relay) test.

Each HV board comes with either a 10W isolated power supply or a 3W one. The contactor version uses 3 watts because the contactor control circuit requires much less low-voltage power than the relay versions do.

The relay boards simply use an MMBT4401 power transistor to switch the relay(s) on and off. A flyback diode protects the transistor from coil collapse voltages. The contactor version uses an opto-isolated driver triac to switch a small triac on and off to control an external line powered contactor. Both the driver and power triacs are provisioned with snubbers to similarly protect them from coil collapse voltages when the contactor is switched off.

The voltmeter is simply one out of four opto-isolators in an LTV-844S connected across the AC line input with a 150 k-ohm series resistor. The series resistor is intended to reduce the current down to the 1-2 mA range, which results in a 0.5-1 mA transfer current (or so) from the transistor on the secondary. This winds up providing an output voltage with peaks at up to around 3 volts or so for 240 Vrms. The secondary is fed into a buffering OP amp and then passed to the logic board.

The ground impedance test has a similar series resistor from one of the two AC power input lines (for hot-neutral power - such as North American 120 volts or 220 volt power outside North America, then you must carefully connect the hot line up to the hot terminal or else the ground test will fail) through a rectifying diode through a 1 mA current limit circuit, another opto-isolator and then to ground. The secondary side of the opto-isolator is fed into an OP amp comparator circuit. The output of that is fed into a simple peak-hold circuit made of a blocking diode, a large cap and a bleed resistor. If the ground impedance is too high, then the secondary current won't be high enough and the comparator won't provide any pulses to the peak-hold cap. The 1 mA current limit makes the test more sensitive, while also limiting the amount of leakage current and limiting the potential shock hazard in a situation where the ground is completely open.

The stuck relay test is a cross between the voltmeter and the ground impedance test. Its primary side is the same as the voltmeter, but instead of being connected to the AC line side, it's connected to the load side of the relay or contactor. The secondary side is the same comparator / peak hold circuit as the ground impedance. The net result is that the controller should - after a short delay - see the relay test line always be the same state as the relay control line. This reflects the presence of AC voltage when the relay is closed and the absence of it when the relay is open.

= Schematics =

  * [http://www.kfu.com/~nsayer/hydra/OpenEVSE_II_Logic_0_4.pdf]
  * [http://www.kfu.com/~nsayer/hydra/OpenEVSE_II_HV_Relay_0_4.pdf]
  * [http://www.kfu.com/~nsayer/hydra/OpenEVSE_II_HV_Contactor_0_4.pdf]